================================================================================
                    DOCUMENTACIÓN DEL PROYECTO INCEPTION
================================================================================

ÍNDICE:
1. Descripción General del Proyecto
2. Makefile - Comandos y Funcionalidad
3. Docker Compose - Orquestación de Contenedores
4. Servicio NGINX - Servidor Web y Proxy Inverso
5. Servicio MariaDB - Base de Datos
6. Servicio WordPress - Sistema de Gestión de Contenidos
7. Volúmenes y Persistencia de Datos
8. Redes y Comunicación entre Servicios
9. Variables de Entorno

================================================================================
1. DESCRIPCIÓN GENERAL DEL PROYECTO
================================================================================

Inception es un proyecto de infraestructura basado en Docker que despliega un
stack completo de WordPress con NGINX y MariaDB. La arquitectura está diseñada
siguiendo las mejores prácticas de contenedorización y seguridad.

COMPONENTES PRINCIPALES:
- NGINX: Servidor web con SSL/TLS (HTTPS)
- WordPress: CMS con PHP-FPM
- MariaDB: Sistema de gestión de base de datos

CARACTERÍSTICAS:
- Todos los servicios corren en contenedores Docker separados
- Comunicación mediante red bridge privada
- Persistencia de datos mediante volúmenes locales
- Certificados SSL autofirmados para HTTPS
- Configuración mediante variables de entorno


================================================================================
2. MAKEFILE - COMANDOS Y FUNCIONALIDAD
================================================================================

El Makefile automatiza la gestión del proyecto Docker Compose.

VARIABLES PRINCIPALES:
--------------------
NAME=inception
  - Nombre del proyecto Docker Compose

COMPOSE_FILE=srcs/docker-compose.yml
  - Ruta al archivo docker-compose.yml principal

ENV_FILE=srcs/.env
  - Ruta al archivo de variables de entorno

LOGIN := $(shell grep '^LOGIN=' $(ENV_FILE) | cut -d'=' -f2)
  - Extrae el nombre de usuario desde el archivo .env
  - Se usa para construir las rutas de los directorios de datos
  -d '=' -f2: Obtiene la segunda parte después del '='

HOST_MARIADB_DIR := /home/$(LOGIN)/data/mariadb
  - Directorio en el host donde se almacenan los datos de MariaDB

HOST_WORDPRESS_DIR := /home/$(LOGIN)/data/wordpress
  - Directorio en el host donde se almacenan los archivos de WordPress


COMANDOS DISPONIBLES:
--------------------

make (o make all)
  - Objetivo por defecto
  - Ejecuta: make up
  - Construye las imágenes y levanta todos los contenedores

make dirs
  - Crea los directorios necesarios para los volúmenes de datos
  - Directorios: $(HOST_MARIADB_DIR) y $(HOST_WORDPRESS_DIR)
  - Muestra un mensaje confirmando las rutas creadas
  - -p opción: crea directorios padres si no existen

make build
  - Dependencia: make dirs
  - Construye las imágenes Docker definidas en docker-compose.yml
  - Usa el nombre del proyecto especificado en $(NAME)
  - No inicia los contenedores
  - -f opción: especifica el archivo docker-compose.yml

make up
  - Dependencia: make build
  - Construye las imágenes (si no existen)
  - Inicia todos los contenedores en modo detached (-d)
  - Los contenedores siguen corriendo en segundo plano

make down
  - Detiene todos los contenedores del proyecto
  - No elimina los contenedores, solo los para

make clean
  - Dependencia: make down
  - Detiene y elimina todos los contenedores
  - Mantiene las imágenes Docker y los volúmenes de datos

make fclean
  - Dependencia: make clean
  - Detiene y elimina los contenedores
  - ELIMINA los directorios de datos (uso con precaución)
  - Requiere permisos sudo para eliminar los directorios
  - ADVERTENCIA: Se pierden todos los datos de la base de datos y WordPress

make re
  - Dependencia: make fclean
  - Reconstrucción completa desde cero
  - Ejecuta: fclean -> up
  - Útil para resetear completamente el proyecto


PHONY TARGETS:
.PHONY: all dirs build up down clean fclean re
  - Declara que estos targets no corresponden a archivos reales
  - Asegura que make siempre ejecute estos comandos


================================================================================
3. DOCKER COMPOSE - ORQUESTACIÓN DE CONTENEDORES
================================================================================

El archivo docker-compose.yml define la arquitectura de servicios del proyecto.

SERVICIOS:
----------

1. SERVICIO MARIADB
   container_name: mariadb
     - Nombre fijo del contenedor
   
   build:
     context: ./requirements/mariadb
     dockerfile: Dockerfile
     - Construye la imagen desde el Dockerfile en requirements/mariadb
   
   image: mariadb
     - Nombre de la imagen resultante
   
   env_file: .env
     - Carga variables de entorno desde el archivo .env
   
   environment:
     - MYSQL_DATABASE: Nombre de la base de datos a crear
     - MYSQL_USER: Usuario de la base de datos
     - ROOT_PASSWORD: Contraseña del usuario root de MySQL
     - USER_PASSWORD: Contraseña del usuario de MySQL
   
   volumes:
     - mariadb_data:/var/lib/mysql
     - Monta el volumen persistente para los datos de la base de datos
   
   networks:
     - inception
     - Conecta el contenedor a la red privada
   
   restart: always
     - Reinicia automáticamente el contenedor si falla
   
   healthcheck:
     test: ["CMD-SHELL", "mysqladmin ping --socket=/run/mysqld/mysqld.sock --silent || exit 1"]
       - Verifica que MariaDB esté respondiendo
     interval: 5s
       - Ejecuta el chequeo cada 5 segundos
     timeout: 3s
       - Tiempo máximo de espera por respuesta
     retries: 30
       - Número de intentos antes de marcar como unhealthy


2. SERVICIO WORDPRESS
   container_name: wordpress
     - Nombre fijo del contenedor
   
   build:
     context: ./requirements/wordpress
     dockerfile: Dockerfile
   
   image: wordpress
   
   env_file: .env
     - Carga variables de entorno desde el archivo .env
   
   environment:
     - LOGIN: Nombre de usuario para generar la URL dinámica
     - MYSQL_DATABASE: Nombre de la base de datos
     - MYSQL_USER: Usuario de la base de datos
     - USER_PASSWORD: Contraseña del usuario de la base de datos
     - WP_ADMIN_USER: Usuario administrador de WordPress
     - WP_ADMIN_PASSWORD: Contraseña del administrador
     - WP_ADMIN_EMAIL: Email del administrador
     - WP_USER: Usuario adicional de WordPress
     - WP_USER_EMAIL: Email del usuario adicional
     - WP_USER_PASSWORD: Contraseña del usuario adicional
   
   volumes:
     - wordpress_data:/var/www/html
     - Almacena los archivos de WordPress de forma persistente
   
   networks:
     - inception
   
   restart: always
   
   depends_on:
     mariadb:
       condition: service_healthy
     - WordPress espera a que MariaDB esté completamente operativo


3. SERVICIO NGINX
   container_name: nginx
     - Nombre fijo del contenedor
   
   build:
     context: ./requirements/nginx
     dockerfile: Dockerfile
   
   image: nginx
   
   env_file: .env
     - Carga variables de entorno desde el archivo .env
   
   environment:
     - LOGIN: Nombre de usuario para generar certificado SSL y server_name dinámico
   
   ports:
     - "443:443"
     - Mapea el puerto 443 del host al puerto 443 del contenedor
     - Permite acceso HTTPS desde el exterior
   
   volumes:
     - wordpress_data:/var/www/html
     - Comparte los archivos de WordPress con NGINX
   
   networks:
     - inception
   
   restart: always
   
   depends_on:
     wordpress:
       condition: service_started
     - NGINX solo inicia después de que WordPress esté iniciado


REDES:
------
inception:
  driver: bridge
    - Red bridge privada para comunicación entre contenedores
    - Los contenedores pueden comunicarse usando sus nombres de servicio
    - Aislada de otras redes Docker


VOLÚMENES:
----------
mariadb_data:
  driver: local
    - Usa el driver local de Docker
  driver_opts:
    type: none
      - No es un tipo de filesystem estándar
    o: bind
      - Monta un directorio del host
    device: /home/mpico-bu/data/mariadb
      - Ruta en el host donde se almacenan los datos

wordpress_data:
  driver: local
  driver_opts:
    type: none
    o: bind
    device: /home/$(LOGIN)/data/wordpress
      - Ruta en el host para los archivos de WordPress


================================================================================
4. SERVICIO NGINX - SERVIDOR WEB Y PROXY INVERSO
================================================================================

DOCKERFILE (requirements/nginx/Dockerfile):
------------------------------------------

FROM debian:bookworm
  - Imagen base: Debian 12 (Bookworm)
  - Sistema operativo estable y ligero

ARG LOGIN=mpico-bu
  - Define un argumento de build para el nombre de usuario
  - Valor por defecto: mpico-bu
  - Se pasa desde docker-compose.yml

RUN apt-get update && apt-get install -y --no-install-recommends nginx openssl
  - Actualiza los repositorios de paquetes
  - Instala NGINX (servidor web) y OpenSSL (para certificados SSL)
  - --no-install-recommends: Solo instala paquetes esenciales
  - Reduce el tamaño de la imagen

rm -rf /var/lib/apt/lists/*
  - Limpia la caché de apt para reducir el tamaño de la imagen

COPY conf/nginx.conf /etc/nginx/nginx.conf
  - Copia la configuración personalizada de NGINX al contenedor
  - Contiene ${LOGIN} como placeholder que será reemplazado en runtime

COPY tools/entrypoint.sh /usr/local/bin/entrypoint.sh
  - Copia el script de inicialización al contenedor

RUN chmod +x /usr/local/bin/entrypoint.sh
  - Hace el script ejecutable

EXPOSE 443
  - Documenta que el contenedor escucha en el puerto 443
  - Solo es informativo, no abre el puerto

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
  - Ejecuta el script de inicialización al arrancar el contenedor
  - El script genera el certificado SSL dinámicamente
  - Reemplaza variables en nginx.conf
  - Inicia NGINX en primer plano


SCRIPT DE INICIALIZACIÓN (requirements/nginx/tools/entrypoint.sh):
-----------------------------------------------------------------

#!/bin/bash
set -e
  - Sale si cualquier comando falla

mkdir -p /etc/nginx/ssl
  - Crea el directorio para los certificados SSL

openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/nginx/ssl/cert.key \
  -out /etc/nginx/ssl/cert.crt \
  -subj "/CN=${LOGIN}.42.fr"
  - Genera un certificado SSL autofirmado dinámicamente:
    * Usa la variable de entorno ${LOGIN}
    * -x509: Formato de certificado X.509
    * -nodes: No cifra la clave privada
    * -days 365: Válido por 1 año
    * -newkey rsa:2048: Genera una nueva clave RSA de 2048 bits
    * -keyout: Ruta de la clave privada
    * -out: Ruta del certificado
    * -subj: Nombre común del certificado (CN) dinámico

sed -i "s/\${LOGIN}/${LOGIN}/g" /etc/nginx/nginx.conf
  - Reemplaza el placeholder ${LOGIN} en nginx.conf con el valor real
  - -i: Edita el archivo in-place
  - Permite tener server_name dinámico basado en la variable de entorno

exec nginx -g "daemon off;"
  - Ejecuta NGINX en primer plano (daemon off)
  - exec: Reemplaza el proceso actual
  - Necesario para que Docker mantenga el contenedor activo


ARCHIVO DE CONFIGURACIÓN (requirements/nginx/conf/nginx.conf):
-------------------------------------------------------------

events {
    worker_connections 1024;
}
  - Configuración de eventos de NGINX
  - worker_connections: Número máximo de conexiones simultáneas por worker
  - 1024 es suficiente para la mayoría de aplicaciones pequeñas

http {
    include /etc/nginx/mime.types;
      - Incluye los tipos MIME estándar para servir archivos correctamente
    
    default_type application/octet-stream;
      - Tipo MIME por defecto si no se identifica el archivo

    server {
        listen 443 ssl;
          - Escucha en el puerto 443 con SSL habilitado
        
        server_name ${LOGIN}.42.fr;
          - Nombre del servidor (dominio) dinámico
          - ${LOGIN} es reemplazado por el entrypoint.sh con el valor real
        
        ssl_protocols TLSv1.2 TLSv1.3;
          - Protocolos SSL/TLS permitidos
          - Solo versiones seguras (TLS 1.2 y 1.3)
        
        ssl_certificate /etc/nginx/ssl/cert.crt;
          - Ruta al certificado SSL
        
        ssl_certificate_key /etc/nginx/ssl/cert.key;
          - Ruta a la clave privada SSL
        
        root /var/www/html;
          - Directorio raíz de los archivos web
        
        index index.php index.html;
          - Archivos de índice a buscar por orden
        
        location / {
            try_files $uri $uri/ /index.php?$args;
        }
          - Maneja las peticiones a la raíz del sitio:
            1. Intenta servir el archivo directamente ($uri)
            2. Intenta servir como directorio ($uri/)
            3. Si no existe, pasa a index.php con los argumentos
          - Necesario para WordPress permalinks
        
        location ~ \.php$ {
            fastcgi_pass wordpress:9000;
              - Reenvía peticiones PHP al servicio wordpress en el puerto 9000
            
            fastcgi_index index.php;
              - Archivo índice para FastCGI
            
            include fastcgi_params;
              - Incluye parámetros estándar de FastCGI
            
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              - Define la ruta completa del script PHP a ejecutar
        }
          - Procesa archivos PHP mediante FastCGI
    }
}


================================================================================
5. SERVICIO MARIADB - BASE DE DATOS
================================================================================

DOCKERFILE (requirements/mariadb/Dockerfile):
--------------------------------------------

FROM debian:bookworm
  - Imagen base Debian 12

RUN apt-get update && apt-get install -y --no-install-recommends mariadb-server mariadb-client
  - Instala el servidor y cliente de MariaDB

rm -rf /var/lib/apt/lists/*
  - Limpia caché de apt

rm -rf /var/lib/mysql/*
  - Limpia el directorio de datos de MySQL existente
  - Necesario para una instalación limpia

mkdir -p /var/lib/mysql
  - Crea el directorio de datos

chown -R mysql:mysql /var/lib/mysql
  - Asigna permisos correctos al usuario mysql

COPY conf/50-server.cnf /etc/mysql/mariadb.conf.d/50-server.cnf
  - Copia la configuración personalizada de MariaDB

COPY tools/entrypoint.sh /usr/local/bin/entrypoint.sh
  - Copia el script de inicialización

RUN chmod +x /usr/local/bin/entrypoint.sh
  - Hace el script ejecutable

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
  - Ejecuta el script de inicialización al iniciar el contenedor

CMD ["mariadbd", "--user=mysql", "--console"]
  - Comando por defecto: inicia MariaDB en modo consola


ARCHIVO DE CONFIGURACIÓN (requirements/mariadb/conf/50-server.cnf):
------------------------------------------------------------------

[mysqld]
  - Sección de configuración del servidor MySQL/MariaDB

bind-address=0.0.0.0
  - Permite conexiones desde cualquier dirección IP
  - Necesario para que WordPress pueda conectarse desde otro contenedor
  - Por defecto, MariaDB solo escucha en localhost

skip-name-resolve
  - Desactiva la resolución DNS de nombres de host
  - Mejora el rendimiento al no hacer búsquedas DNS
  - Las conexiones usan solo direcciones IP

character-set-server=utf8mb4
  - Conjunto de caracteres por defecto del servidor
  - utf8mb4 soporta caracteres Unicode completos (incluidos emojis)

collation-server=utf8mb4_unicode_ci
  - Reglas de comparación para ordenar y comparar textos
  - utf8mb4_unicode_ci: case-insensitive, compatible con Unicode


SCRIPT DE INICIALIZACIÓN (requirements/mariadb/tools/entrypoint.sh):
-------------------------------------------------------------------

#!/bin/bash
set -eo pipefail
  - -e: Sale si cualquier comando falla
  - -o pipefail: Falla si algún comando en un pipeline falla

MYSQL_ROOT_PASSWORD="${ROOT_PASSWORD}"
MYSQL_PASSWORD="${USER_PASSWORD}"
MYSQL_DATABASE="${MYSQL_DATABASE:-wordpress}"
MYSQL_USER="${MYSQL_USER:-wp_user}"
  - Define variables de entorno con valores por defecto
  - ${VAR:-default}: Usa el valor de VAR o "default" si está vacío

if [ -z "$MYSQL_ROOT_PASSWORD" ] || [ -z "$MYSQL_PASSWORD" ]; then
  echo "Error: Passwords not set"
  exit 1
fi
  - Verifica que las contraseñas estén definidas
  - -z: Verdadero si la cadena está vacía

mkdir -p /run/mysqld
chown -R mysql:mysql /run/mysqld /var/lib/mysql
  - Crea el directorio para el socket de MySQL
  - Asigna permisos correctos

if [ -z "$(ls -A /var/lib/mysql)" ]; then
  - Verifica si el directorio de datos está vacío
  - Si está vacío, es la primera ejecución

  mysql_install_db --user=mysql --datadir=/var/lib/mysql --auth-root-authentication-method=normal
    - Inicializa la estructura de la base de datos
    - --auth-root-authentication-method=normal: Usa contraseña para root

  mysqld --user=mysql --skip-networking --socket=/run/mysqld/mysqld.sock &
  pid="$!"
    - Inicia MariaDB temporalmente en background
    - --skip-networking: Solo acepta conexiones por socket
    - Guarda el PID del proceso

  for i in {1..40}; do
    mariadb-admin --protocol=socket --socket=/run/mysqld/mysqld.sock ping --silent && break
    sleep 0.5
  done
    - Espera a que MariaDB esté listo
    - Hace hasta 40 intentos (20 segundos total)

  mysql --protocol=socket --socket=/run/mysqld/mysqld.sock <<-SQL
    ALTER USER 'root'@'localhost' IDENTIFIED BY '${MYSQL_ROOT_PASSWORD}';
    FLUSH PRIVILEGES;
    CREATE DATABASE IF NOT EXISTS \`${MYSQL_DATABASE}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
    CREATE USER IF NOT EXISTS '${MYSQL_USER}'@'%' IDENTIFIED BY '${MYSQL_PASSWORD}';
    GRANT ALL PRIVILEGES ON \`${MYSQL_DATABASE}\`.* TO '${MYSQL_USER}'@'%';
    FLUSH PRIVILEGES;
  SQL
    - Ejecuta comandos SQL de inicialización:
      1. Establece la contraseña de root
      2. Recarga los privilegios
      3. Crea la base de datos con charset utf8mb4
      4. Crea el usuario desde cualquier host ('%')
      5. Otorga todos los privilegios al usuario sobre la base de datos
      6. Recarga los privilegios de nuevo

  mariadb-admin --protocol=socket --socket=/run/mysqld/mysqld.sock -uroot -p"${MYSQL_ROOT_PASSWORD}" shutdown
  wait "$pid"
    - Detiene el servidor temporal
    - Espera a que el proceso termine limpiamente

fi

exec "$@"
  - Ejecuta el comando especificado en CMD (mariadbd)
  - exec reemplaza el proceso actual, no crea un subproceso


================================================================================
6. SERVICIO WORDPRESS - SISTEMA DE GESTIÓN DE CONTENIDOS
================================================================================

DOCKERFILE (requirements/wordpress/Dockerfile):
----------------------------------------------

FROM debian:bookworm
  - Imagen base Debian 12

RUN apt-get update && apt-get install -y --no-install-recommends \
      php8.2-fpm \
      php8.2-mysql \
      php8.2-curl \
      php8.2-gd \
      php8.2-mbstring \
      php8.2-xml \
      curl \
      ca-certificates
  - Instala PHP 8.2 con extensiones necesarias:
    * php8.2-fpm: FastCGI Process Manager para procesar PHP
    * php8.2-mysql: Extensión para conectar con MySQL/MariaDB
    * php8.2-curl: Para hacer peticiones HTTP
    * php8.2-gd: Librería de manipulación de imágenes
    * php8.2-mbstring: Manejo de strings multibyte (UTF-8)
    * php8.2-xml: Procesamiento de XML
    * curl: Cliente HTTP para descargar archivos
    * ca-certificates: Certificados para conexiones HTTPS

curl -L https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar -o /usr/local/bin/wp
chmod +x /usr/local/bin/wp
  - Descarga WP-CLI (WordPress Command Line Interface)
  - Herramienta para gestionar WordPress desde la terminal
  - Le da permisos de ejecución

rm -rf /var/lib/apt/lists/*
  - Limpia caché de apt

COPY conf/www.conf /etc/php/8.2/fpm/pool.d/www.conf
  - Copia la configuración de PHP-FPM

COPY tools/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh
  - Copia y hace ejecutable el script de inicialización

EXPOSE 9000
  - PHP-FPM escucha en el puerto 9000
  - NGINX se conectará a este puerto

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["php-fpm8.2", "-F"]
  - Ejecuta el script de inicialización
  - Inicia PHP-FPM en primer plano (-F)


ARCHIVO DE CONFIGURACIÓN (requirements/wordpress/conf/www.conf):
---------------------------------------------------------------

[www]
  - Nombre del pool de PHP-FPM

user = www-data
group = www-data
  - Usuario y grupo con el que se ejecuta PHP-FPM
  - www-data es el usuario estándar para servicios web en Debian

listen = 9000
  - Puerto en el que PHP-FPM escucha conexiones
  - NGINX se conectará aquí

pm = dynamic
  - Process Manager en modo dinámico
  - Ajusta automáticamente el número de procesos según la carga

pm.max_children = 5
  - Número máximo de procesos hijo
  - Límite superior de procesos que pueden crearse

pm.start_servers = 2
  - Número de procesos creados al iniciar
  - Valor inicial

pm.min_spare_servers = 1
  - Mínimo de procesos en espera (idle)
  - Si hay menos, se crean nuevos procesos

pm.max_spare_servers = 3
  - Máximo de procesos en espera
  - Si hay más, se eliminan procesos


SCRIPT DE INICIALIZACIÓN (requirements/wordpress/tools/entrypoint.sh):
---------------------------------------------------------------------

#!/bin/bash
set -e
  - Sale si cualquier comando falla

sleep 5
  - Espera 5 segundos para que MariaDB esté completamente listo
  - Aunque healthcheck dice que está ready, es buena práctica esperar

if [ ! -f /var/www/html/wp-config.php ]; then
  - Verifica si WordPress ya está instalado
  - Si wp-config.php no existe, es la primera instalación

  cd /var/www/html
    - Cambia al directorio de WordPress

  wp core download --allow-root
    - Descarga los archivos principales de WordPress
    - --allow-root: Permite ejecutar WP-CLI como root

  wp config create \
    --dbname="$MYSQL_DATABASE" \
    --dbuser="$MYSQL_USER" \
    --dbpass="$USER_PASSWORD" \
    --dbhost="mariadb:3306" \
    --allow-root
    - Crea el archivo wp-config.php con:
      * Nombre de la base de datos
      * Usuario de la base de datos
      * Contraseña del usuario
      * Host de la base de datos (nombre del servicio + puerto)

  wp core install \
    --url="https://${LOGIN}.42.fr" \
    --title="Inception" \
    --admin_user="$WP_ADMIN_USER" \
    --admin_password="$WP_ADMIN_PASSWORD" \
    --admin_email="$WP_ADMIN_EMAIL" \
    --allow-root
    - Instala WordPress:
      * URL del sitio (dinámica basada en variable LOGIN)
      * Título del sitio
      * Usuario administrador
      * Contraseña del administrador
      * Email del administrador

  wp user create \
    "$WP_USER" \
    "$WP_USER_EMAIL" \
    --role=author \
    --user_pass="$WP_USER_PASSWORD" \
    --allow-root
    - Crea un usuario adicional:
      * Nombre de usuario
      * Email del usuario
      * Rol: author (puede crear y editar sus propios posts)
      * Contraseña del usuario

fi

exec "$@"
  - Ejecuta el comando CMD (php-fpm8.2 -F)


================================================================================
7. VOLÚMENES Y PERSISTENCIA DE DATOS
================================================================================

Los volúmenes garantizan que los datos persistan incluso si los contenedores
se eliminan o reconstruyen.

VOLUMEN MARIADB (mariadb_data):
------------------------------
Directorio del contenedor: /var/lib/mysql
Directorio del host: /home/$(LOGIN)/data/mariadb

CONTENIDO:
- Bases de datos de MariaDB
- Tablas y datos
- Logs de transacciones
- Configuraciones internas

IMPORTANCIA:
- Sin este volumen, se perderían todos los datos al eliminar el contenedor
- Permite hacer backup del directorio del host
- Los datos sobreviven a make clean


VOLUMEN WORDPRESS (wordpress_data):
----------------------------------
Directorio del contenedor: /var/www/html
Directorio del host: /home/$(LOGIN)/data/wordpress

CONTENIDO:
- Archivos core de WordPress
- Temas instalados
- Plugins instalados
- Archivos multimedia subidos
- wp-config.php (configuración)

COMPARTIDO CON:
- Contenedor de WordPress: Para ejecutar PHP
- Contenedor de NGINX: Para servir archivos estáticos

IMPORTANCIA:
- Persistencia de personalizaciones
- Los archivos subidos no se pierden
- Permite actualizar WordPress manteniendo datos


TIPO DE MONTAJE (bind mount):
----------------------------
driver: local
driver_opts:
  type: none
  o: bind
  device: /ruta/en/host

VENTAJAS:
- Control total sobre la ubicación de los datos
- Fácil acceso para backups
- No depende de la gestión de volúmenes de Docker

DESVENTAJAS:
- Requiere crear manualmente los directorios
- Dependencia de permisos del sistema de archivos del host


================================================================================
8. REDES Y COMUNICACIÓN ENTRE SERVICIOS
================================================================================

RED INCEPTION:
-------------
Tipo: bridge
Nombre: inception

FUNCIONAMIENTO:
- Docker crea una red bridge privada
- Cada contenedor obtiene una IP en esta red
- Los contenedores se comunican usando nombres de servicio como DNS

COMUNICACIONES:

1. NGINX -> WORDPRESS
   Conexión: nginx se comunica con wordpress:9000
   Protocolo: FastCGI
   Propósito: Procesar archivos PHP

2. WORDPRESS -> MARIADB
   Conexión: wordpress se comunica con mariadb:3306
   Protocolo: MySQL Protocol
   Propósito: Consultas a la base de datos

3. CLIENTE -> NGINX
   Conexión: Host:443 -> nginx:443
   Protocolo: HTTPS (HTTP over TLS)
   Propósito: Acceso web desde el exterior

AISLAMIENTO:
- Los servicios no son accesibles directamente desde el exterior
- Solo NGINX expone el puerto 443 al host
- MariaDB y WordPress solo son accesibles dentro de la red inception


RESOLUCIÓN DE NOMBRES:
---------------------
Docker proporciona DNS interno:
- "mariadb" resuelve a la IP del contenedor mariadb
- "wordpress" resuelve a la IP del contenedor wordpress
- "nginx" resuelve a la IP del contenedor nginx

Esto permite usar nombres en lugar de IPs hardcodeadas.


================================================================================
9. VARIABLES DE ENTORNO
================================================================================

El archivo srcs/.env contiene todas las variables de configuración.

ESTRUCTURA DEL ARCHIVO .env (ejemplo):
-------------------------------------

# Información del usuario
LOGIN=mpico-bu
  - Nombre de usuario del sistema
  - Usado para:
    * Construir rutas de volúmenes en el Makefile
    * Generar URL dinámica de WordPress
    * Generar certificado SSL con dominio dinámico
    * Configurar server_name en NGINX

# Configuración de la base de datos
MYSQL_DATABASE=wordpress
MYSQL_USER=wp_user
ROOT_PASSWORD=contraseña_root_segura
USER_PASSWORD=contraseña_usuario_segura

# Configuración de WordPress - Administrador
WP_ADMIN_USER=admin
WP_ADMIN_PASSWORD=contraseña_admin_segura
WP_ADMIN_EMAIL=admin@example.com

# Configuración de WordPress - Usuario adicional
WP_USER=usuario
WP_USER_EMAIL=usuario@example.com
WP_USER_PASSWORD=contraseña_usuario_segura


DESCRIPCIÓN DE VARIABLES:
------------------------

LOGIN:
  - Nombre de usuario en el sistema
  - Usado para:
    * Construir rutas de volúmenes (/home/LOGIN/data/...)
    * Generar URL de WordPress (https://LOGIN.42.fr)
    * Generar certificado SSL con CN=LOGIN.42.fr
    * Configurar server_name en NGINX
  - IMPORTANTE: Debe coincidir con tu login de 42

MYSQL_DATABASE:
  - Nombre de la base de datos a crear
  - WordPress usará esta base de datos

MYSQL_USER:
  - Usuario de MySQL/MariaDB
  - Tendrá permisos sobre MYSQL_DATABASE

ROOT_PASSWORD:
  - Contraseña del usuario root de MariaDB
  - Acceso administrativo completo a la base de datos

USER_PASSWORD:
  - Contraseña del MYSQL_USER
  - WordPress usa esta contraseña para conectarse

WP_ADMIN_USER:
  - Nombre del usuario administrador de WordPress
  - Tendrá rol de administrador

WP_ADMIN_PASSWORD:
  - Contraseña del administrador de WordPress
  - Debe ser segura (mínimo 8 caracteres, mezcla de caracteres)

WP_ADMIN_EMAIL:
  - Email del administrador
  - Para notificaciones y recuperación de contraseña

WP_USER:
  - Nombre de un usuario adicional de WordPress
  - Tendrá rol de autor

WP_USER_EMAIL:
  - Email del usuario adicional

WP_USER_PASSWORD:
  - Contraseña del usuario adicional


SEGURIDAD:
---------
- El archivo .env NUNCA debe subirse a repositorios públicos
- Debe estar en .gitignore
- Usar contraseñas fuertes y únicas
- Cambiar contraseñas por defecto en producción


================================================================================
10. FLUJO DE INICIO DEL PROYECTO
================================================================================

CUANDO SE EJECUTA "make up":
---------------------------

1. make dirs
   - Se crean /home/$(LOGIN)/data/mariadb y /home/$(LOGIN)/data/wordpress

2. make build
   - Docker construye las imágenes:
     a) Lee cada Dockerfile
     b) Descarga imagen base (debian:bookworm)
     c) Ejecuta comandos RUN
     d) Copia archivos COPY
     e) Genera imágenes: mariadb, wordpress, nginx

3. make up
   - Docker Compose inicia los servicios:

   PASO 1 - MariaDB inicia:
     a) Crea contenedor mariadb
     b) Monta volumen mariadb_data
     c) Ejecuta entrypoint.sh
     d) Si es primera vez:
        - Inicializa la base de datos
        - Crea usuario y base de datos
     e) Inicia mariadbd
     f) Healthcheck verifica que responde

   PASO 2 - WordPress inicia (espera a que MariaDB esté healthy):
     a) Crea contenedor wordpress
     b) Monta volumen wordpress_data (compartido con nginx)
     c) Ejecuta entrypoint.sh
     d) Si es primera vez:
        - Descarga WordPress
        - Crea wp-config.php con credenciales de BD
        - Instala WordPress con URL dinámica (https://${LOGIN}.42.fr)
        - Crea usuario adicional
     e) Inicia PHP-FPM en puerto 9000

   PASO 3 - NGINX inicia (espera a que WordPress esté started):
     a) Crea contenedor nginx
     b) Monta volumen wordpress_data (compartido con wordpress)
     c) Ejecuta entrypoint.sh
     d) El entrypoint:
        - Genera certificado SSL con CN=${LOGIN}.42.fr
        - Reemplaza ${LOGIN} en nginx.conf
     e) Inicia nginx en puerto 443
     f) Expone puerto 443 al host

4. Sistema listo
   - Accesible en https://${LOGIN}.42.fr (ej: https://mpico-bu.42.fr)
   - NGINX sirve archivos estáticos y proxy de PHP a WordPress

4. Sistema listo
   - Accesible en https://mpico-bu.42.fr
   - NGINX sirve archivos estáticos y proxy de PHP a WordPress
   - WordPress procesa PHP y consulta MariaDB


================================================================================
FIN DE LA DOCUMENTACIÓN
================================================================================

Este documento describe completamente el proyecto Inception, su arquitectura,
configuración y funcionamiento. Para más información sobre Docker Compose,
consultar: https://docs.docker.com/compose/

Autor: mpico-bu
Fecha: Noviembre 2025
Proyecto: 42 School - Inception
